doctype html
// Uso

///////////// Configuraci√≥n del motor
// textos:
mixin texto
  p(bp-style="texto")
    block
mixin mirar
  div(bp-style="mirar")
    block
mixin stop
  div(bp-style="stop")
    block
mixin seccion
  div(bp-style="seccion")
    block
// margenes y formato
mixin pie
  div(bp-style="pie")
    hr
// comandos:    
mixin cmd
  pre(bp-style="cmd")
    block
// par√°metros que van a ser reemplazados dentro de los comandos:
mixin parametro(nombre_variable)
  div(bp-style="parametros")
    label(bp-style="parametro-nombre") #{nombre_variable}
      input(bp-parametro=nombre_variable)
mixin parametro_sino(nombre_variable)
  div(bp-style="parametros")
    label(bp-style="parametro-nombre") #{nombre_variable}
      input(type="checkbox" bp-parametro=nombre_variable)
mixin parametro_sino_texto(nombre_variable_sino, nombre_variable_texto, valor_por_defecto, valor_unchecked = null)
  div(bp-style="parametros")
    label(bp-style="parametro-nombre") #{nombre_variable_sino}
      input(type="checkbox" bp-parametro=nombre_variable_sino)
      if valor_unchecked == null
        input(bp-parametro=nombre_variable_texto, value=valor_por_defecto, style="width:30em")
      else
        input(bp-parametro=nombre_variable_texto, value=valor_por_defecto, style="width:30em", bp-unchecked-value=valor_unchecked)
mixin solo_si(condicion)
  span(bp-solo-si=condicion)
    block
mixin sino
  span(bp-sino="sino")
    block
///////////// Fin de la configuraci√≥n del motor
html 
  head
    link(rel="stylesheet" href="./documentador-backend-plus.css")
  body 
    h1 Operaciones sobre servidores de aplicaciones Backend-Plus
    +texto.
      Prototipo de conjunto de operaciones sobre servidores de aplicaciones Backend-Plus.
    +parametro("nombre_instancia")
    +parametro("sql_actualizacion")
    +parametro_sino_texto("db_en_otro_servidor", "db_otro_servidor", "--host=$db_host --port=$db_port --username=$db_owner ", "")
    +seccion.
      Lectura del archivo de configuraci√≥n de la instancia (yaml)
    +cmd.
      sudo ls -cal /opt/insts

      export nombre_dir=${nombre_instancia}
      source /opt/bin/bash-yaml/script/yaml.sh
      create_variables /opt/insts/${nombre_dir}.yaml
      export NVM_DIR="/opt/.nvm"
      cd $NVM_DIR
      [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"

      echo $server_base_url $server_port $db_database
    +mirar.
      Revisar que la ruta, el puerto y el nombre de la base de datos coincidan. 
      ‚ûú Corregir el nombre_instancia si no coincide
    +seccion.
      Bajada de la nueva versi√≥n.
    +cmd.
      cd /opt/npm/$nombre_dir/
      sudo chown -R $USER .
      
      git log -1 >>instalaciones.txt
      git pull
    +stop.
      Si el repositorio es privado el servidor podr√≠a pedir que introduzcas tu usuario y token de GitHub.
    +seccion.
      Instalaci√≥n.
    +cmd.
      rm -r dist
      npm ci
    +solo_si("!sql_actualizacion")
      +stop.
        Si hay cambios en la base de datos, este es el lugar para impactarlos.
    +sino
      +cmd.
        sudo -u postgres psql ${db_otro_servidor} -v ON_ERROR_STOP=on --quiet --single-transaction --pset pager=off --file ${sql_actualizacion} $db_database
      +solo_si("db_en_otro_servidor")
        +texto.
          acladardo
    +seccion.
      Finalizaci√≥n de la instalaci√≥n. Arrancar el servicio.
    +cmd.
      sudo chown root /opt/npm
      sudo chown -R root /opt/nginx.conf
      sudo chown -R root /opt/services
      sudo chown -R root /opt/bin
      sudo chmod +x /opt/bin/coderun/script/run-app.sh
      sudo chown -R ${server_user} /opt/npm/$nombre_dir
      sudo systemctl daemon-reload
      sudo systemctl stop $nombre_dir.service
      sudo systemctl restart $nombre_dir.service
    +stop.
      Verificar que el servicio se ha iniciado correctamente logue√°ndose en el sistema.
      ‚ûú Si no arrancara hay que mirar los logs. üí° Recordar <kbd>Shift</kbd><kbd>G</kbd> va al final del archivo.
    +cmd.
      journalctl -u $nombre_dir --since "${ultimos_minutos}
    +pie.
  script(src="./documentador-backend-plus.js")
